<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>用Deno脚本加速MediaWiki导入</title>
<meta name="keywords" content="MediaWiki,XML,Dump,Deno,导入,cookie,AbortController" />
<link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='用deno脚本加速mediawiki导入'><span>用Deno脚本加速MediaWiki导入</span></h1><p><span>我们架设了一个Wiki网站，用维基百科一样的MediaWiki软件。MediaWiki提供多种方式导入其他wiki上的页面。其中一种是供网站开发者用的，使用维护脚本importDump.php在控制台导入XML dump。而还有一种，是在网站上使用</span><code>Special:Import</code><span>导入页面来导入。前者问题比较小，但是需要更高的权限，使用SSH连接命令行执行；而后者只要有跨wiki的导入权限，一般用户也可以执行。</span></p><p><span>我们以为这两种方式本质是一样的。但实际运行起来，我们的测试系统却频频出现宕机、报错（数据库执行超时）等问题。当然我们服务出问题也可能是多种原因，因此我们也努力改善周边的设施，但导入失败的事情依然困扰着我们的用户。</span></p><p><span>如果不解决这一点的话，可能未来也有其他隐患。我算是从另一个角度切入这个问题。我判断这个问题的一部分原因是</span><code>Special:Import</code><span>这个导入方式只设计了成功和失败两个结果。因为如此，所以这个过程开启了一个大大的TRANSACTION（事务），在我们的小机器上，可能就造成了超时或者长时间的数据库锁吧。</span></p><p><span>如果是这样的话，是否把导入过程拆分就能解决了呢？带着这样的想法，我尝试把原始的XML文件按照page进行切分，把每一份都进行上传，即便有一些不成功，也至少不会有太长的锁吧。有了这个想法，我就开始找，有没有现成的上传API呢？果然MediaWIki提供了，就是</span><a href='https://www.mediawiki.org/wiki/API:Import'><span>API:Import</span></a><span>。但为了成功调用import，我们还需要做前面的获取登录token、登录、获取csrf token这一整套流程。但由于官网上有node版本以及python版本的实现了，所以这不算太难。</span></p><p><span>唯一有点考验的应该就是deno的fetch请求默认不支持存储cookie吧。在官方的示例里，我们看到无论是Python也好，Node.js也好，都会先声明一下存放cookie的地方。看起来也许不起眼，但它们都做了这件事</span></p><p><span>Python版：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span> = <span class="cm-variable">requests</span>.<span class="cm-property">Session</span>()</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>Node.js版</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">request</span> <span class="cm-operator">=</span> <span class="cm-variable">require</span>(<span class="cm-string">'request'</span>).<span class="cm-property">defaults</span>({<span class="cm-property">jar</span>: <span class="cm-atom">true</span>})</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>存放cookie的地方在业界有一个好听的名字，cookie jar，也就是“饼干罐”的意思。其实Deno的第三方库里也有这样的存在，就是</span><a href='https://deno.land/x/another_cookiejar'><span>another_cookiejar</span></a><span>。而且它起名another的意图是为了不占据cookiejar这个名字。不过我想要展示给大家更加朴素的储存cookie的方式，就是自己去解析服务器返回的Header里面的</span><code>Set-Cookie</code><span>，并且把它存储起来。事实上我曾经用Lua编写维基机器人的时候，也是用的手工解析cookie的方式。</span></p><p><span>拿最简单的获取登录token来当例子好了</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">export</span> <span class="cm-keyword">async</span> <span class="cm-keyword">function</span> <span class="cm-def">getLoginToken</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">const</span> <span class="cm-def">url</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">URL</span>(<span class="cm-variable">apiUrl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">url</span>.<span class="cm-property">search</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">URLSearchParams</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">action</span>: <span class="cm-string">'query'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">meta</span>: <span class="cm-string">'tokens'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">type</span>: <span class="cm-string">'login'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">format</span>: <span class="cm-string">'json'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }).<span class="cm-property">toString</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">const</span> <span class="cm-def">res</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">fetch</span>(<span class="cm-variable-2">url</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">cacheCookies</span>(<span class="cm-variable-2">res</span>.<span class="cm-property">headers</span>.<span class="cm-property">get</span>(<span class="cm-string">'set-cookie'</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">const</span> <span class="cm-def">data</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable-2">res</span>.<span class="cm-property">json</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable-2">data</span>.<span class="cm-property">query</span>.<span class="cm-property">tokens</span>.<span class="cm-property">logintoken</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 299px;"></div><div class="CodeMirror-gutters" style="display: none; height: 299px;"></div></div></div></pre><p><span>因为是给Deno写代码，我们尽量用比较推荐的方式。虽然我们日常都用拼接字符串的方式解决GET请求的参数，但这里我使用更加标准的方式，建立URL对象，并且用URLSearchParams对象来建立它的参数串。这样的方式就有我们在jQuery里面直接传入对象的感觉了。用fetch的方式拿到请求的结果，之后从它的header里面取出来</span><code>set-cookie</code><span>解析后存储起来，就可以继续获取body的JSON信息然后拿到token了。</span></p><p><span>那么cacheCookies里面是什么呢？下面就给大家看一下</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-def">setCookie</span> <span class="cm-keyword">from</span> <span class="cm-string">'./set-cookie-parser.js'</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">cacheCookies</span>(<span class="cm-def">combinedCookieHeader</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">let</span> <span class="cm-def">splitCookieHeaders</span> <span class="cm-operator">=</span> <span class="cm-variable">setCookie</span>.<span class="cm-property">splitCookiesString</span>(<span class="cm-variable-2">combinedCookieHeader</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">let</span> <span class="cm-def">cookies</span> <span class="cm-operator">=</span> <span class="cm-variable">setCookie</span>.<span class="cm-property">parse</span>(<span class="cm-variable-2">splitCookieHeaders</span>, { <span class="cm-property">decodeValues</span>: <span class="cm-atom">false</span> });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">headers</span>.<span class="cm-property">set</span>(<span class="cm-string">'Cookie'</span>, <span class="cm-variable-2">cookies</span>.<span class="cm-property">map</span>(<span class="cm-def">x</span> <span class="cm-operator">=&gt;</span> <span class="cm-string-2">`${</span><span class="cm-variable-2">x</span>.<span class="cm-property">name</span><span class="cm-string-2">}=${</span><span class="cm-variable-2">x</span>.<span class="cm-property">value</span><span class="cm-string-2">}`</span>).<span class="cm-property">join</span>(<span class="cm-string">'; '</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p><span>这边我用到了一个外部库，叫做set-cookie-parser。这个库是在node领域的一个很流行的库，用来解析</span><code>Set-Cookie</code><span>的内容。不是我实现不了，只是不想再费劲自己去写一个了。但是需要注意，我们用Deno拿到的</span><code>Set-Cookie</code><span>是用逗号连接起来的，多个</span><code>Set-Cookie</code><span>拼接起来的。所以需要先split一下才能调用parse。但这个split并不是简单朴素的split，所以如果自己实现需要注意，因为单个cookie里面，Expires日期字段，也是有逗号的，如果不注意，就会把单个cookie从内部分开了。</span></p><p><span>就这样，以同样的方式，我们就能实现</span><code>getLoginToken</code><span>、</span><code>loginRequest</code><span>、</span><code>getCsrfToken</code><span>和</span><code>importXML</code><span>四个函数了。官方的Node.js实现采用了一环套一环的传统异步程序编写方式，但我们在Deno里，当然要用async...await了，不能被时代落下。</span></p><p><span>介绍完核心部分，这篇文章就结束了吗？不是的，我认为主要流程方面也需要介绍一下。XML的拆分page就是简单的字符串匹配，没什么好讲的。我想要讲的就是主循环部分。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> (<span class="cm-variable">xmlPool</span>.<span class="cm-property">length</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">'POOL LENGTH: '</span> <span class="cm-operator">+</span> <span class="cm-variable">xmlPool</span>.<span class="cm-property">length</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">// get csrf token</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">mwapi</span>.<span class="cm-property">getCsrfToken</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  } <span class="cm-keyword">catch</span> (<span class="cm-def">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">const</span> <span class="cm-def">controller</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">AbortController</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">await</span> <span class="cm-variable">Promise</span>.<span class="cm-property">all</span>(<span class="cm-variable">xmlPool</span>.<span class="cm-property">map</span>(<span class="cm-def">x</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">mwapi</span>.<span class="cm-property">importXML</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">`${</span><span class="cm-variable">mwStart</span><span class="cm-string-2">}${</span><span class="cm-variable">siteInfo</span><span class="cm-string-2">}${</span><span class="cm-variable-2">x</span><span class="cm-string-2">}${</span><span class="cm-variable">mwEnd</span><span class="cm-string-2">}`</span>, <span class="cm-variable-2">controller</span>.<span class="cm-property">signal</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ))).<span class="cm-property">then</span>(<span class="cm-def">values</span> <span class="cm-operator">=&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-keyword">const</span> <span class="cm-def">i</span> <span class="cm-keyword">in</span> <span class="cm-variable-2">values</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable-2">values</span>[<span class="cm-variable-2">i</span>].<span class="cm-property">error</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable-2">values</span>[<span class="cm-variable-2">i</span>].<span class="cm-property">error</span>.<span class="cm-property">code</span> <span class="cm-operator">===</span> <span class="cm-string">'badtoken'</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">controller</span>.<span class="cm-property">abort</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">failedXML</span>.<span class="cm-property">push</span>(<span class="cm-variable">xmlPool</span>[<span class="cm-variable-2">i</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">xmlPool</span>.<span class="cm-property">length</span> <span class="cm-operator">===</span> <span class="cm-variable">failedXML</span>.<span class="cm-property">length</span>) <span class="cm-keyword">break</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">xmlPool</span> <span class="cm-operator">=</span> <span class="cm-variable">failedXML</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">failedXML</span> <span class="cm-operator">=</span> [];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> (<span class="cm-variable">failedXML</span>.<span class="cm-property">length</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Deno</span>.<span class="cm-property">writeTextFile</span>(<span class="cm-string">'failed.xml'</span>, <span class="cm-string-2">`${</span><span class="cm-variable">mwStart</span><span class="cm-string-2">}${</span><span class="cm-variable">siteInfo</span><span class="cm-string-2">}${</span><span class="cm-variable">failedXML</span>.<span class="cm-property">join</span>(<span class="cm-string">''</span>)<span class="cm-string-2">}${</span><span class="cm-variable">mwEnd</span><span class="cm-string-2">}`</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">console</span>.<span class="cm-property">error</span>(<span class="cm-string">'Last run didn\'t consume any input, import unsuccessful. Failed pages can be re-imported with failed.xml.'</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 805px;"></div><div class="CodeMirror-gutters" style="display: none; height: 805px;"></div></div></div></pre><p><span>我在主循环部分也玩了玩花样。虽然这看起来是再平常不过的主循环。我认为这里面主要特别的地方就是错误处理。按我的理解，有些异常处理就是要在主循环里做的，如果放在封装的API里就处理掉了，那我们在主循环里就不能做我们想做的事了。</span></p><p><span>先提一下，我之前处理好的XML片段我都存到了</span><code>xmlPool</code><span>这个数组里面，这里就直接用了。由于我们各个条目之间没有谁先谁后的关系，所以为了发挥好异步的优势，我直接就用了</span><code>Promise.all</code><span>这个语法。它是能够代替你管理这些Promise的一个语法，而且你能知道什么时候所有这些请求都执行完了。</span><code>Promise.all</code><span>这个函数本身返回的也是一个</span><code>Promise</code><span>，所以为了后面的代码能够在这后面执行，我直接就在前面加了await，意思是“后面的等一等”。</span></p><p><span>在主循环里我用了一个没用过的功能，一个在MDN上标注是Experimental的功能，那就是</span><code>AbortController</code><span>。我把它用在了CSRF token失效的情景。因为我发现普通账号在上传50次左右的时候，系统就会让你的CSRF token过期。如果过期了，那么还在跑的其他fetch请求不就没用了嘛。我不想让它们继续浪费时间，我想要在我收到</span><code>badtoken</code><span>错误的时候，立刻把其他的fetch都停掉。而这项功能，目前也就用</span><code>AbortController</code><span>可以优雅地实现。</span><code>AbortController</code><span>会有一个signal，在你发出abort命令的时候，那些仍然没有resolve的fetch将会立即停掉。</span></p><p><span>还有就是，我在检测到某一次循环一个XML片段都没有用掉的时候，我就会跳出循环了。因为可能遇到什么外部故障了。此时跳出循环，我可以把剩余的没有传成功的XML还按MediaWiki dump的格式组织起来，以便网络条件好的时候再次传输。</span></p><hr /><p><span>以上就是我制作的加速MediaWiki导入的Deno脚本的核心内容啦。要说明一下，我最初写的时候，主循环没有这么麻烦的。因为我首要的任务是确定这么做确实能够在我们的环境顺利导入，而且不会把服务或数据库搞出问题。但是有了几位朋友用过之后，就遇到了一些不稳定的问题，这才让我再次将异常处理做得更好，让它成为一个较为稳定的工具。</span><a href='../' title='返回首页'><span>∎</span></a></p></div></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>