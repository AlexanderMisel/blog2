<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>深入了解Ace Editor的mode</title>
<meta name="keywords" content="Ace Editor,mode,undocumented,编辑器,文档" />
<link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='深入了解ace-editor的mode'><span>深入了解Ace Editor的mode</span></h1><p><span>Ace Editor是一款非常有名的基于Web的源代码编辑器，具有丰富的可扩展性，而且性能也很棒，处理上百万行代码不在话下。据我所知，维基百科、可汗学院、Overleaf、CodeCombat等知名网站都在使用这款编辑器。不过，它也有一个大问题就是文档写得非常简陋。</span></p><p><span>Ace Editor用来支持语法高亮的资源文件称作language mode（语言模式），Ace提供了扩展自定义语言mode的方法</span><sup class='md-footnote'><a href='#dfref-footnote-1' name='ref-footnote-1'>1</a></sup><span>，但根据这个文档去看很多现有的mode都会一头雾水，因为有很多用法在文档里一个字都没有写。不过在本文中，我会把我阅读Ace代码了解到的东西都分享给大家，这样大家就不用再读一遍代码了。</span></p><h2 id='最基本的mode用法'><span>最基本的mode用法</span></h2><p><span>还是从文档里已经介绍的基本用法讲起。每个mode都会把它包含的所有规则放在</span><code>this.$rules</code><span>之中。这些规则每个用一个数组表示。虽然格式相同，但是有一个地位特殊，那就是</span><code>start</code><span>这条规则，它是整个规则集的入口。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">this</span>.<span class="cm-property">$rules</span> <span class="cm-operator">=</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">start</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  { <span class="cm-property">token</span>: <span class="cm-variable">t1</span>, <span class="cm-property">regex</span>: <span class="cm-variable">r1</span>, <span class="cm-property">next</span>: <span class="cm-variable">n1</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  { <span class="cm-property">token</span>: <span class="cm-variable">t2</span>, <span class="cm-property">regex</span>: <span class="cm-variable">r2</span>, <span class="cm-property">next</span>: <span class="cm-variable">n2</span> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">t1</span>: [ <span class="cm-meta">...</span> ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">t2</span>: [ <span class="cm-meta">...</span> ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre><p><span>每条规则的数组就类似于PEG中的</span><strong><span>有序选择</span></strong><span>，排在前面的规则优先，而且前面匹配成功就不会检查后面的规则。</span><code>token</code><span>一般是一个数组，在经过</span><code>regex</code><span>匹配过后所有的捕获会按照顺序对应上</span><code>token</code><span>里面的每一项。</span><code>next</code><span>表示下一个状态（规则），如果不指定</span><code>next</code><span>的话，则会返回</span><code>start</code><span>规则。</span></p><p><span>我们可以简单地利用基本用法来识别一下MediaWiki中的标题</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">start</span>: [ <span class="cm-string">'heading'</span> ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">heading</span>: [{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">token</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"punctuation.definition.heading"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"entity.name.section"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"punctuation.definition.heading"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">regex</span>: <span class="cm-string-2">/(={1,6})(.+?)(\1)(?!=)/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 253px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre><h2 id='官方文档未提到的用法'><span>官方文档未提到的用法</span></h2><p><span>几乎大部分我们接下来要介绍的用法都是在</span><code>text_highlight_rules.js</code><span>这个mode中实现的。这个mode应该算是一种meta mode，并非针对一种语言。而是几乎所有语言都理所当然地要继承这个mode。更准确地，是通过</span><code>this.normalizeRules</code><span>这个函数来实现的。</span></p><h3 id='push与pop'><span>push与pop</span></h3><p><span>可以发现很多现有的mode都使用了这个特性。那么它是做什么的呢？从名字我们就可以大概猜出来，应该是实现了一个stack。那么什么情况下会用到这个特性呢？通常在用来保证语法的开始与结束能够配对的时候需要用。就比如在MediaWiki中模板定义文法中的模板参数的fallback链，就需要用到。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="mediawiki"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="mediawiki"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{{{ 123 | test{{{456}}}xasd }}}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>为了能让内部参数456的结尾</span><code>}}}</code><span>不会被误认为结束外部参数123，我们这里就要在每次开启参数的时候push进去一个state，每次关闭参数的时候pop一下，这样就不会造成内部关闭外部的情形了。实际写出来大概就是这样：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">start</span>: [ <span class="cm-string">'argument'</span> ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">argument</span>: [{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">stateName</span>: <span class="cm-string">'openArg'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">token</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"variable.parameter"</span>, <span class="cm-string">"text"</span>, <span class="cm-string">"variable.other"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"text"</span>, <span class="cm-string">"keyword.operator"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">regex</span>: <span class="cm-string-2">/({{{)(\s*)(\w+)(\s*)((?:\|)?)/</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">push</span>: [{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">token</span>: <span class="cm-string">"variable.parameter"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">regex</span>: <span class="cm-string-2">/}}}/</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">next</span>: <span class="cm-string">"pop"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }, <span class="cm-string">'start'</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 368px;"></div><div class="CodeMirror-gutters" style="display: none; height: 368px;"></div></div></div></pre><p><span>在Ace中push是用一个数组来表示的，比较反直观，而且</span><code>push</code><span>实际上也隐含</span><code>next</code><span>的意味。上面定义的规则的意思是说，我这个</span><code>openArg</code><span>啊，它要push到stack里，同时它的下一条状态就是push里面这个数组（因为在Ace里面，就是用数组来表示rule）。</span></p><p><span>那好啦，到了下一个状态的时候，它就会按照顺序，先匹配</span><code>}}}</code><span>这条规则，一旦匹配上，那就会调用pop，也就意味着要跳出内部这个argument了。那么为什么还要加一个</span><code>start</code><span>呢？这个的作用是说，我argument内部是要按照start规则来匹配的，放到MediaWiki里意思就是说，我模板参数的fallback可以是任何wikitext，当然也能包含另一个模板参数啦。</span></p><h3 id='其他特性'><span>其他特性</span></h3><ul><li><p><code>include</code><span>指令：用来引用</span><code>$rules</code><span>中定义好的规则，但我更推荐直接用规则的名字引用，如上面</span><code>push</code><span>里面的</span><code>start</code><span>。很多从tmLanguage文件会包含一个</span><code>include: &#39;$self&#39;</code><span>的写法，这个写法经我验证在Ace中无效，应当改为对</span><code>start</code><span>的引用</span></p></li><li><p><code>defaultToken</code><span>指令：意思就是不管匹配到啥都按这个token处理，等价于</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ <span class="cm-variable">token</span>: <span class="cm-string">'defaultToken'</span>, <span class="cm-variable">regex</span>: <span class="cm-string-2">/.+/</span> }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><code>caseInsensitive</code><span>指令，用来让regex互略大小写区别</span></p></li><li><p><code>onMatch</code><span>指令，这个指令是一个函数，其返回值将作为</span><code>token</code><span>使用。</span><code>onMatch</code><span>接收的参数分别是value, currentState, stack, line，它的</span><code>value</code><span>参数能够提供正则表达式匹配结果中的每个捕获。事实上这个指令本来是原来</span><code>token</code><span>传函数的情况，但由于作者修改代码的时候忽视了文档这部分，于是将原有功能改为用</span><code>onMatch</code><span>实现。</span><sup class='md-footnote'><a href='#dfref-footnote-2' name='ref-footnote-2'>2</a></sup></p></li><li><p><code>rules</code><span>指令所做的事是这样的：对于它内部的规则，如果全局</span><code>$rules</code><span>没这条规则，那么就把它赋给全局；如果没有呢，就用里面的push函数刷一遍全局的</span><code>$rules</code><span>。说实话我也没搞懂具体是用来做什么的。这个指令使用得很少，目前只有ruby、sh和crystal三个mode在用。</span></p></li></ul><h2 id='结语'><span>结语</span></h2><p><span>在弄清Ace Editor的文档未写清的特性之后，Ace Editor就变为了一个容易扩展语言的一个编辑器，并且性能还不错。在扩展语言mode的方式方面，其他JS代码编辑器（如CodeMirror）也大同小异。</span></p><p><span>这篇文章我想要达到的作用就是，把这些重要的参数介绍给大家，让大家至少能够看懂已经有的这些mode是在做什么。因为我发现在我弄懂，写这篇文章之前，我真的看不懂它那些push、pop是什么意思，到底为啥rule是写成数组形式等等。当然这也反映出写好文档的重要性。</span><a href='../' title='返回首页'><span>∎</span></a></p><div class='footnotes-area'  ><hr/>
<div class='footnote-line'><span class='md-fn-count'>1</span> <a href='https://ace.c9.io/#nav=higlighter' target='_blank' class='url'>https://ace.c9.io/#nav=higlighter</a> <a name='dfref-footnote-1' href='#ref-footnote-1' title='回到文档' class='reversefootnote' >↩</a></div>
<div class='footnote-line'><span class='md-fn-count'>2</span> <a href='https://github.com/ajaxorg/ace/issues/1269' target='_blank' class='url'>https://github.com/ajaxorg/ace/issues/1269</a> <a name='dfref-footnote-2' href='#ref-footnote-2' title='回到文档' class='reversefootnote' >↩</a></div></div></div></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>